<!doctype html>
<!-- This site was created with Hugo Blox. https://hugoblox.com -->
<!-- Last Published: March 15, 2025 --><html lang="en-us" dir="ltr"
      data-wc-theme-default="system">
  
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="generator" content="Hugo Blox Builder 0.3.1" />

  
  












  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Francis L. Huang" />

  
  
  
    
  
  <meta name="description" content="Francis Huang / projects / research." />

  
  <link rel="alternate" hreflang="en-us" href="http://localhost:1313/post/residuals_mlm/" />

  
  
  
  
    
    <link rel="stylesheet" href="/css/themes/blue.min.css" />
  

  
  
    
    <link href="/dist/wc.min.css" rel="stylesheet" />
  

  
  
  

  

  <script>
     
    window.hbb = {
       defaultTheme: document.documentElement.dataset.wcThemeDefault,
       setDarkTheme: () => {
        document.documentElement.classList.add("dark");
        document.documentElement.style.colorScheme = "dark";
      },
       setLightTheme: () => {
        document.documentElement.classList.remove("dark");
        document.documentElement.style.colorScheme = "light";
      }
    }

    console.debug(`Default Hugo Blox Builder theme is ${window.hbb.defaultTheme}`);

    if ("wc-color-theme" in localStorage) {
      localStorage.getItem("wc-color-theme") === "dark" ? window.hbb.setDarkTheme() : window.hbb.setLightTheme();
    } else {
      window.hbb.defaultTheme === "dark" ? window.hbb.setDarkTheme() : window.hbb.setLightTheme();
      if (window.hbb.defaultTheme === "system") {
        window.matchMedia("(prefers-color-scheme: dark)").matches ? window.hbb.setDarkTheme() : window.hbb.setLightTheme();
      }
    }
  </script>

  <script>
    
    document.addEventListener('DOMContentLoaded', function () {
      
      let checkboxes = document.querySelectorAll('li input[type=\'checkbox\'][disabled]');
      checkboxes.forEach(e => {
        e.parentElement.parentElement.classList.add('task-list');
      });

      
      const liNodes = document.querySelectorAll('.task-list li');
      liNodes.forEach(nodes => {
        let textNodes = Array.from(nodes.childNodes).filter(node => node.nodeType === 3 && node.textContent.trim().length > 1);
        if (textNodes.length > 0) {
          const span = document.createElement('label');
          textNodes[0].after(span);  
          span.appendChild(nodes.querySelector('input[type=\'checkbox\']'));
          span.appendChild(textNodes[0]);
        }
      });
    });
  </script>

  
  
  




































  
  
    <link rel="alternate" href="/post/residuals_mlm/index.xml" type="application/rss+xml" title="FLH Website" />
  

  
  <link rel="icon" type="image/png" href="/media/icon_hu_8d92228bfbb2ace7.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hu_2b4ad1f159ffa531.png" />

  <link rel="canonical" href="http://localhost:1313/post/residuals_mlm/" />

  
  
  
  
  
  
  
  
    
    
  
  

  
  
    
    
  
  <meta property="twitter:card" content="summary" />
  
    <meta property="twitter:site" content="@GetResearchDev" />
    <meta property="twitter:creator" content="@GetResearchDev" />
  
  <meta property="og:site_name" content="FLH Website" />
  <meta property="og:url" content="http://localhost:1313/post/residuals_mlm/" />
  <meta property="og:title" content="Residuals with Multilevel Models | FLH Website" />
  <meta property="og:description" content="Francis Huang / projects / research." /><meta property="og:image" content="http://localhost:1313/media/icon_hu_258291280f5c9c98.png" />
    <meta property="twitter:image" content="http://localhost:1313/media/icon_hu_258291280f5c9c98.png" /><meta property="og:locale" content="en-us" />
  
    
      <meta property="og:updated_time" content="2023-09-01T00:00:00&#43;00:00" />
    
  

  




  <title>Residuals with Multilevel Models | FLH Website</title>

  
  
  
  
  
    
    
  
  
  <style>
    @font-face {
      font-family: 'Inter var';
      font-style: normal;
      font-weight: 100 900;
      font-display: swap;
      src: url(/dist/font/Inter.var.woff2) format(woff2);
    }
  </style>

  

  
  


  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
      
      
        
        
          
        
          
        
          
        
          
        
          
        
        
        
      
    
      
      
    
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  







<link type="text/css" rel="stylesheet" href="/dist/pagefind/pagefind-ui.be766eb419317a14ec769d216e9779bfe8f3737c80e780f4ba0dafb57a41a482.css" integrity="sha256-vnZutBkxehTsdp0hbpd5v&#43;jzc3yA54D0ug2vtXpBpII=" />


<script src="/dist/pagefind/pagefind-ui.87693d7c6f2b3b347ce359d0ede762c033419f0a32b22ce508c335a81d841f1b.js" integrity="sha256-h2k9fG8rOzR841nQ7ediwDNBnwoysizlCMM1qB2EHxs="></script>


<script>window.hbb.pagefind = {"baseUrl":"/"};</script>

<style>
  html.dark {
    --pagefind-ui-primary: #eeeeee;
    --pagefind-ui-text: #eeeeee;
    --pagefind-ui-background: #152028;
    --pagefind-ui-border: #152028;
    --pagefind-ui-tag: #152028;
  }
</style>

<script>
  window.addEventListener('DOMContentLoaded', (event) => {
    new PagefindUI({
      element: "#search",
      showSubResults: true,
      baseUrl: window.hbb.pagefind.baseUrl,
      bundlePath: window.hbb.pagefind.baseUrl + "pagefind/",
    });
  });
  document.addEventListener('DOMContentLoaded', () => {
    let element = document.getElementById('search');
    let trigger = document.getElementById('search_toggle');

    if (trigger) {
      trigger.addEventListener('click', () => {
        element.classList.toggle('hidden');
        element.querySelector("input").value = ""
        element.querySelector("input").focus()

        if (!element.classList.contains('hidden')) {
          let clear_trigger = document.querySelector('.pagefind-ui__search-clear');

          if (clear_trigger && !clear_trigger.hasAttribute('listenerOnClick')) {
            clear_trigger.setAttribute('listenerOnClick', 'true');

            clear_trigger.addEventListener('click', () => {
              element.classList.toggle('hidden');
            });
          }
        }

      });
    }
  });
</script>










  
  
  <link type="text/css" rel="stylesheet" href="/dist/lib/katex/katex.min.505d5f829022bb7b4f24dfee0aa1141cd7bba67afe411d1240335f820960b5c3.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr&#43;QR0SQDNfgglgtcM=" />
  
  
  <script defer src="/dist/lib/katex/katex.min.dc84b296ec3e884de093158f760fd9d45b6c7abe58b5381557f4e138f46a58ae.js" integrity="sha256-3ISyluw&#43;iE3gkxWPdg/Z1Ftser5YtTgVV/ThOPRqWK4="></script>
  
  
  
  
  <script defer src="/js/katex-renderer.6579ec9683211cfb952064aedf3a3baea5eeb17a061775b32b70917474637c80.js" integrity="sha256-ZXnsloMhHPuVIGSu3zo7rqXusXoGF3WzK3CRdHRjfIA="></script>
  
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  






  
  
  
  
  
  
  
  <script
    defer
    src="/js/hugo-blox-en.min.js"
    integrity=""
  ></script>

  
  








  
    
      
      <script async defer src="https://buttons.github.io/buttons.js"></script>

      
    
  




</head>

  <body class="dark:bg-hb-dark dark:text-white page-wrapper" id="top">
    <div id="page-bg"></div>
    <div class="page-header sticky top-0 z-30">
      
      
      
        
        
        
          <header id="site-header" class="header">
  <nav class="navbar px-3 flex justify-left">
    <div class="order-0 h-100">
      
      <a class="navbar-brand" href="/" title="FLH Website">
        Francis L. Huang
      </a>
    </div>
    
    <input id="nav-toggle" type="checkbox" class="hidden" />
    <label
      for="nav-toggle"
      class="order-3 cursor-pointer flex items-center lg:hidden text-dark dark:text-white lg:order-1">
      <svg id="show-button" class="h-6 fill-current block" viewBox="0 0 20 20">
        <title>Open Menu</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
      <svg id="hide-button" class="h-6 fill-current hidden" viewBox="0 0 20 20">
        <title>Close Menu</title>
        <polygon
          points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
          transform="rotate(45 10 10)"></polygon>
      </svg>
    </label>
    

    
    
    <ul
      id="nav-menu"
      class="navbar-nav order-3 hidden lg:flex w-full pb-6 lg:order-1 lg:w-auto lg:space-x-2 lg:pb-0 xl:space-x-8 justify-left
      ">
      
      
      
      
      
      
      <li class="nav-item">
        <a
          class="nav-link "
          
          href="/#talks"
        >Talks</a
        >
      </li>
      
      
      
      
      
      
      <li class="nav-item">
        <a
          class="nav-link "
          
          href="/#news"
        >Posts</a
        >
      </li>
      
      
      
      
      
      
      <li class="nav-item">
        <a
          class="nav-link "
          
          href="/MLMusingR/"
        >MLMusingR</a
        >
      </li>
      
      
      
      
      
      
      <li class="nav-item">
        <a
          class="nav-link "
          
          href="/projects/"
        >Projects</a
        >
      </li>
      
      
      
      
      
      
      <li class="nav-item">
        <a
          class="nav-link "
          
          href="/teaching/"
        >Teaching</a
        >
      </li>
      
      
      
      
      
      
      <li class="nav-item">
        <a
          class="nav-link "
          
          href="/service/"
        >Service</a
        >
      </li>
      
      
      
      
      
      
      <li class="nav-item nav-dropdown group relative">
            <span
              class="nav-link 
                
                
                
              
                
                
                
               inline-flex items-center">
              Research
              <svg class="h-4 w-4 fill-current inline-block" viewBox="0 0 20 20">
                <path
                  d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" />
              </svg>
            </span>
        <ul
          class="nav-dropdown-list lg:group-hover:visible lg:group-hover:opacity-100">
          
          
          
          <li class="nav-dropdown-item">
            <a
              class="nav-dropdown-link "
              
              href="/#papers">
              Papers
            </a>
          </li>
          
          
          
          <li class="nav-dropdown-item">
            <a
              class="nav-dropdown-link "
              
              href="/r">
              R Packages
            </a>
          </li>
          
        </ul>
      </li>
      
      
      
    </ul>

    <div class="order-1 ml-auto flex items-center md:order-2 lg:ml-0">

      
      
      
      <button
        aria-label="search"
        class="text-black hover:text-primary  inline-block px-3 text-xl dark:text-white"
        id="search_toggle">
        <svg xmlns="http://www.w3.org/2000/svg" height="16" width="16" viewBox="0 0 512 512" fill="currentColor"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"/></svg>
      </button>
      

      
      
      <div class="px-3 text-black hover:text-primary-700 dark:text-white dark:hover:text-primary-300
            [&.active]:font-bold [&.active]:text-black/90 dark:[&.active]:text-white">
        <button class="theme-toggle mt-1" accesskey="t" title="appearance">
          <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
               stroke-linejoin="round" class="dark:hidden">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
          <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
               stroke-linejoin="round" class=" dark:block [&:not(dark)]:hidden">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </button>
      </div>
      

      
      

      
      
    </div>
  </nav>
</header>


<div id="search" class="hidden p-3"></div>


        
      
    </div>
    <div class="page-body  my-10">
      

<div class="max-w-prose mx-auto flex justify-center">
  <article class="prose prose-slate lg:prose-xl dark:prose-invert">
    <h1 class="lg:text-6xl">Residuals with Multilevel Models</h1>
    <p>(MLM notes). Residuals are often used for model diagnostics or for spotting outliers in the data. For single-level models, these are merely the observed - predicted data (i.e., $y_i - \hat{y}_i$). However, for multilevel models, these are a bit more complicated to compute. Since we have two error terms (in this example), we will have two sets of residuals. For example, a multilevel model with a single predictor at level one can be written as:</p>
$$y_{ij} = \gamma_{00} + \gamma_{01}x_{ij} + u_{0j} + r_{ij}$$<p>
The $u_{0j}$ represent the estimated level-2 residuals and are assumed to be normally distributed with a mean of 0 and variance of $\tau_{00}$ or $\mathcal{N}\sim(0, \tau_{00})$.</p>
<h2 id="read-in-and-examine-the-data">Read in and examine the data</h2>
<p>A small three cluster dataset (<code>comb</code>) is used (so we can see and compare results of our computations done manually and automatically using functions). There are only 20 observations in the data nested within 3 clusters.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">lme4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">MLMusingR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nf">load</span><span class="p">(</span><span class="nf">url</span><span class="p">(</span><span class="s">&#34;https://github.com/flh3/pubdata/raw/main/miscdata/three_groups.rda&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">comb</span> <span class="o">&lt;-</span> <span class="n">three_group</span>
</span></span><span class="line"><span class="cl"><span class="nf">names</span><span class="p">(</span><span class="n">comb</span><span class="p">)</span><span class="n">[2]</span> <span class="o">&lt;-</span> <span class="s">&#34;xij&#34;</span> <span class="c1">#just renaming</span>
</span></span><span class="line"><span class="cl"><span class="nf">ggplot</span><span class="p">(</span><span class="n">comb</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">xij</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">group</span> <span class="o">=</span> <span class="n">gp</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">gp</span><span class="p">))</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">geom_point</span><span class="p">()</span> <span class="o">+</span> 
</span></span><span class="line"><span class="cl">  <span class="nf">geom_smooth</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s">&#39;lm&#39;</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="bp">F</span><span class="p">)</span> <span class="o">+</span> <span class="nf">theme_bw</span><span class="p">()</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">labs</span><span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>















<figure  >
  <div class="flex justify-center	">
    <div class="w-100" ><img alt="plot of chunk unnamed-chunk-1" srcset="
               /post/residuals_mlm/unnamed-chunk-1-1_hu_c760d42701693f15.webp 400w,
               /post/residuals_mlm/unnamed-chunk-1-1_hu_428b99cb8edbbc2.webp 760w,
               /post/residuals_mlm/unnamed-chunk-1-1_hu_28a467643da43829.webp 1200w"
               src="/post/residuals_mlm/unnamed-chunk-1-1_hu_c760d42701693f15.webp"
               width="504"
               height="504"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<h2 id="fit-a-random-intercept-model">Fit a random intercept model</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">m1</span> <span class="o">&lt;-</span> <span class="nf">lmer</span><span class="p">(</span><span class="n">y</span> <span class="o">~</span> <span class="n">xij</span> <span class="o">+</span> <span class="p">(</span><span class="m">1</span><span class="o">|</span><span class="n">gp</span><span class="p">),</span> <span class="n">data</span> <span class="o">=</span> <span class="n">comb</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">summary</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-zed" data-lang="zed"><span class="line"><span class="cl"><span class="n">Linear</span><span class="w"> </span><span class="n">mixed</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">fit</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">REML</span><span class="p">.</span><span class="w"> </span><span class="n">t</span><span class="o">-</span><span class="n">tests</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">Satterthwaite</span><span class="err">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="p">[</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">lmerModLmerTest</span><span class="p">]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Formula</span><span class="o">:</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">xij</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="err">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">gp</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">Data</span><span class="o">:</span><span class="w"> </span><span class="n">comb</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">REML</span><span class="w"> </span><span class="n">criterion</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">convergence</span><span class="o">:</span><span class="w"> </span><span class="err">18</span><span class="p">.</span><span class="err">9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Scaled</span><span class="w"> </span><span class="n">residuals</span><span class="o">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Min</span><span class="w">      </span><span class="err">1</span><span class="n">Q</span><span class="w">  </span><span class="n">Median</span><span class="w">      </span><span class="err">3</span><span class="n">Q</span><span class="w">     </span><span class="n">Max</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">-</span><span class="err">1</span><span class="p">.</span><span class="err">9164</span><span class="w"> </span><span class="o">-</span><span class="err">0</span><span class="p">.</span><span class="err">2511</span><span class="w"> </span><span class="o">-</span><span class="err">0</span><span class="p">.</span><span class="err">0196</span><span class="w">  </span><span class="err">0</span><span class="p">.</span><span class="err">3605</span><span class="w">  </span><span class="err">2</span><span class="p">.</span><span class="err">1738</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Random</span><span class="w"> </span><span class="n">effects</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Groups</span><span class="w">   </span><span class="n">Name</span><span class="w">        </span><span class="n">Variance</span><span class="w"> </span><span class="n">Std</span><span class="p">.</span><span class="n">Dev</span><span class="p">.</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">gp</span><span class="w">       </span><span class="p">(</span><span class="n">Intercept</span><span class="p">)</span><span class="w"> </span><span class="err">0</span><span class="p">.</span><span class="err">214</span><span class="w">    </span><span class="err">0</span><span class="p">.</span><span class="err">463</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Residual</span><span class="w">             </span><span class="err">0</span><span class="p">.</span><span class="err">107</span><span class="w">    </span><span class="err">0</span><span class="p">.</span><span class="err">327</span><span class="w">   
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Number</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">obs</span><span class="o">:</span><span class="w"> </span><span class="err">20</span><span class="p">,</span><span class="w"> </span><span class="n">groups</span><span class="o">:</span><span class="w">  </span><span class="n">gp</span><span class="p">,</span><span class="w"> </span><span class="err">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Fixed</span><span class="w"> </span><span class="n">effects</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="n">Estimate</span><span class="w"> </span><span class="n">Std</span><span class="p">.</span><span class="w"> </span><span class="n">Error</span><span class="w">     </span><span class="n">df</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">Pr</span><span class="p">(</span><span class="o">&gt;|</span><span class="n">t</span><span class="o">|</span><span class="p">)</span><span class="w">    
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">(</span><span class="n">Intercept</span><span class="p">)</span><span class="w">    </span><span class="err">9</span><span class="p">.</span><span class="err">239</span><span class="w">      </span><span class="err">1</span><span class="p">.</span><span class="err">849</span><span class="w"> </span><span class="err">12</span><span class="p">.</span><span class="err">207</span><span class="w">    </span><span class="err">5</span><span class="p">.</span><span class="err">00</span><span class="w">   </span><span class="err">0</span><span class="p">.</span><span class="err">0003</span><span class="w"> </span><span class="o">***</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xij</span><span class="w">            </span><span class="err">1</span><span class="p">.</span><span class="err">165</span><span class="w">      </span><span class="err">0</span><span class="p">.</span><span class="err">342</span><span class="w"> </span><span class="err">12</span><span class="p">.</span><span class="err">915</span><span class="w">    </span><span class="err">3</span><span class="p">.</span><span class="err">41</span><span class="w">   </span><span class="err">0</span><span class="p">.</span><span class="err">0047</span><span class="w"> </span><span class="o">**</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="o">---</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Signif</span><span class="p">.</span><span class="w"> </span><span class="n">codes</span><span class="o">:</span><span class="w">  </span><span class="err">0</span><span class="w"> </span><span class="err">&#39;</span><span class="o">***</span><span class="err">&#39;</span><span class="w"> </span><span class="err">0</span><span class="p">.</span><span class="err">001</span><span class="w"> </span><span class="err">&#39;</span><span class="o">**</span><span class="err">&#39;</span><span class="w"> </span><span class="err">0</span><span class="p">.</span><span class="err">01</span><span class="w"> </span><span class="err">&#39;</span><span class="o">*</span><span class="err">&#39;</span><span class="w"> </span><span class="err">0</span><span class="p">.</span><span class="err">05</span><span class="w"> </span><span class="err">&#39;</span><span class="p">.</span><span class="err">&#39;</span><span class="w"> </span><span class="err">0</span><span class="p">.</span><span class="err">1</span><span class="w"> </span><span class="err">&#39;</span><span class="w"> </span><span class="err">&#39;</span><span class="w"> </span><span class="err">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Correlation</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">Fixed</span><span class="w"> </span><span class="n">Effects</span><span class="o">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="n">Intr</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">xij</span><span class="w"> </span><span class="o">-</span><span class="err">0</span><span class="p">.</span><span class="err">989</span><span class="w">
</span></span></span></code></pre></div><p>We will use the <code>m1</code> object in our computations. We can first begin by extracting our variance components of $\tau_{00}$ and $\sigma^2$ from the <code>merMod</code> object.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># extract and save variance components</span>
</span></span><span class="line"><span class="cl"><span class="n">T00</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="nf">VarCorr</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span><span class="o">$</span><span class="n">vcov[1]</span>
</span></span><span class="line"><span class="cl"><span class="n">sig2</span> <span class="o">&lt;-</span> <span class="nf">sigma</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span><span class="n">^2</span>
</span></span></code></pre></div><p>We also of course still need to get the predicted values. With MLMs, you can get the conditional predicted values (that include the random effects) and the marginal predicted values (only using the fixed effects). For this, we need the marginal values. We can compute this using some basic matrix algebra and compare it to the predicted values using the <code>predict</code> function (note the <code>re.form = NA</code> option).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="c1"># the design matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">&lt;-</span> <span class="nf">fixef</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="c1"># the regression coefficients</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">comb</span><span class="o">$</span><span class="n">yhat</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="n">X</span> <span class="o">%*%</span> <span class="n">B</span><span class="p">))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> [1] 14.9 14.7 14.6 15.0 15.0 15.4 14.8 15.3 15.4 15.6 15.5 16.1 16.0 15.7
</span></span><span class="line"><span class="cl">[15] 15.9 16.2 16.1 16.6 16.0 16.0
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">predict</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">re.form</span> <span class="o">=</span> <span class="kc">NA</span><span class="p">)</span> <span class="c1"># the same</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   1    2    4    6    7    8    9   12   13   16   17   21   23   24   25 
</span></span><span class="line"><span class="cl">14.9 14.7 14.6 15.0 15.0 15.4 14.8 15.3 15.4 15.6 15.5 16.1 16.0 15.7 15.9 
</span></span><span class="line"><span class="cl">  26   27   28   29   30 
</span></span><span class="line"><span class="cl">16.2 16.1 16.6 16.0 16.0 
</span></span></code></pre></div><p>From here, we can compute the residuals as in the single-level model ($y_{ij} - \hat{y}_{ij}$). We will use these in our computations of our level-specific residuals.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># computing raw residuals (obs - predicted)</span>
</span></span><span class="line"><span class="cl"><span class="n">comb</span><span class="o">$</span><span class="n">resid</span> <span class="o">&lt;-</span> <span class="n">comb</span><span class="o">$</span><span class="n">y</span> <span class="o">-</span> <span class="n">comb</span><span class="o">$</span><span class="n">yhat</span>
</span></span></code></pre></div><p>We also need the average residuals per group. These estimates will then be shrunken using a shrinkage factor (or the reliability). The depends on the random effect estimates and the number of observations within each cluster <em>j</em>. If the sample sizes were balanced, this would be the same for each cluster. The more observations in a cluster, the more reliable the estimate.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># computing average raw residuals per group</span>
</span></span><span class="line"><span class="cl"><span class="n">comb</span><span class="o">$</span><span class="n">rj</span> <span class="o">&lt;-</span> <span class="nf">group_mean</span><span class="p">(</span><span class="n">comb</span><span class="o">$</span><span class="n">resid</span><span class="p">,</span> <span class="n">comb</span><span class="o">$</span><span class="n">gp</span><span class="p">)</span> <span class="c1">#function is from MLMusingR</span>
</span></span></code></pre></div><p>The shrinkage factor uses the reliability of the random effects (i.e., the intercept) per group ($\frac{\tau_{00}}{\tau_{00} + \sigma^2/n_j}$).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># how many in each cluster</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">nj</span> <span class="o">&lt;-</span> <span class="nf">table</span><span class="p">(</span><span class="n">comb</span><span class="o">$</span><span class="n">gp</span><span class="p">))</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">1 2 3 
</span></span><span class="line"><span class="cl">7 4 9 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># computing shrinkage factor</span>
</span></span><span class="line"><span class="cl"><span class="n">shrink</span> <span class="o">&lt;-</span> <span class="n">T00</span> <span class="o">/</span> <span class="p">(</span><span class="n">T00</span> <span class="o">+</span> <span class="n">sig2</span><span class="o">/</span> <span class="n">nj</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="nf">names</span><span class="p">(</span><span class="n">shrink</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">names</span><span class="p">(</span><span class="n">nj</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tmp</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">shrink</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">names</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#39;gp&#39;</span><span class="p">,</span> <span class="s">&#39;shrink&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">tmp</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">  gp shrink
</span></span><span class="line"><span class="cl">1  1  0.934
</span></span><span class="line"><span class="cl">2  2  0.889
</span></span><span class="line"><span class="cl">3  3  0.948
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># merging shrinkage estimates to the dataset</span>
</span></span><span class="line"><span class="cl"><span class="n">comb</span> <span class="o">&lt;-</span> <span class="nf">merge</span><span class="p">(</span><span class="n">comb</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="s">&#39;gp&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>The shrunken random effects are the average random effect per group (<code>rj</code>) $\times$ the shrinkage factor (or the reliability of the residuals). These residuals are referred to as precision weighted.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">comb</span><span class="o">$</span><span class="n">rj2</span> <span class="o">&lt;-</span> <span class="n">comb</span><span class="o">$</span><span class="n">rj</span> <span class="o">*</span> <span class="n">comb</span><span class="o">$</span><span class="n">shrink</span> <span class="c1"># shrunken</span>
</span></span><span class="line"><span class="cl"><span class="n">comb</span><span class="o">$</span><span class="n">rj2[</span><span class="o">!</span><span class="nf">duplicated</span><span class="p">(</span><span class="n">comb</span><span class="o">$</span><span class="n">rj2</span><span class="p">)</span><span class="n">]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[1] -0.479  0.249  0.230
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">ranef</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="c1"># same as this if using a function</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">$</span><span class="n">gp</span>
</span></span><span class="line"><span class="cl">  <span class="p">(</span><span class="n">Intercept</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span>      <span class="o">-</span><span class="mf">0.479</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span>       <span class="mf">0.249</span>
</span></span><span class="line"><span class="cl"><span class="mi">3</span>       <span class="mf">0.230</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">with</span> <span class="n">conditional</span> <span class="n">variances</span> <span class="k">for</span> <span class="s2">&#34;gp&#34;</span> 
</span></span></code></pre></div><p>Now we can compute the residuals at level one as the residuals - the random effects associated with the cluster.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">comb</span><span class="o">$</span><span class="n">residm</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="n">comb</span><span class="o">$</span><span class="n">resid</span> <span class="o">-</span> <span class="n">comb</span><span class="o">$</span><span class="n">rj2</span><span class="p">)</span> <span class="c1"># computed manually</span>
</span></span><span class="line"><span class="cl"><span class="n">comb</span><span class="o">$</span><span class="n">residauto</span> <span class="o">&lt;-</span> <span class="nf">as.numeric</span><span class="p">(</span><span class="nf">resid</span><span class="p">(</span><span class="n">m1</span><span class="p">))</span> <span class="c1"># extracted using a function </span>
</span></span><span class="line"><span class="cl"><span class="nf">all.equal</span><span class="p">(</span><span class="n">comb</span><span class="o">$</span><span class="n">residm</span><span class="p">,</span> <span class="n">comb</span><span class="o">$</span><span class="n">residauto</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[1] TRUE
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">comb</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   gp    y  xij yhat   resid     rj shrink    rj2   residm residauto
</span></span><span class="line"><span class="cl">1   1 14.0 4.90 14.9 -0.9901 -0.513  0.934 -0.479 -0.51100  -0.51100
</span></span><span class="line"><span class="cl">2   1 14.6 4.67 14.7 -0.1206 -0.513  0.934 -0.479  0.35855   0.35855
</span></span><span class="line"><span class="cl">3   1 14.2 4.56 14.6 -0.4036 -0.513  0.934 -0.479  0.07552   0.07552
</span></span><span class="line"><span class="cl">4   1 14.5 4.94 15.0 -0.4626 -0.513  0.934 -0.479  0.01656   0.01656
</span></span><span class="line"><span class="cl">5   1 14.4 4.91 15.0 -0.5546 -0.513  0.934 -0.479 -0.07547  -0.07547
</span></span><span class="line"><span class="cl">6   1 14.9 5.29 15.4 -0.4938 -0.513  0.934 -0.479 -0.01464  -0.01464
</span></span><span class="line"><span class="cl">7   1 14.2 4.79 14.8 -0.5673 -0.513  0.934 -0.479 -0.08814  -0.08814
</span></span><span class="line"><span class="cl">8   2 15.5 5.17 15.3  0.2511  0.280  0.889  0.249  0.00181   0.00181
</span></span><span class="line"><span class="cl">9   2 16.0 5.27 15.4  0.6168  0.280  0.889  0.249  0.36748   0.36748
</span></span><span class="line"><span class="cl">10  2 15.9 5.44 15.6  0.2982  0.280  0.889  0.249  0.04887   0.04887
</span></span><span class="line"><span class="cl">11  2 15.5 5.41 15.5 -0.0447  0.280  0.889  0.249 -0.29399  -0.29399
</span></span><span class="line"><span class="cl">12  3 15.7 5.90 16.1 -0.3961  0.243  0.948  0.230 -0.62585  -0.62585
</span></span><span class="line"><span class="cl">13  3 16.9 5.77 16.0  0.9397  0.243  0.948  0.230  0.70991   0.70991
</span></span><span class="line"><span class="cl">14  3 15.7 5.56 15.7 -0.0373  0.243  0.948  0.230 -0.26705  -0.26705
</span></span><span class="line"><span class="cl">15  3 16.4 5.73 15.9  0.4985  0.243  0.948  0.230  0.26874   0.26874
</span></span><span class="line"><span class="cl">16  3 16.6 5.94 16.2  0.4741  0.243  0.948  0.230  0.24434   0.24434
</span></span><span class="line"><span class="cl">17  3 16.3 5.91 16.1  0.1659  0.243  0.948  0.230 -0.06385  -0.06385
</span></span><span class="line"><span class="cl">18  3 16.8 6.29 16.6  0.2324  0.243  0.948  0.230  0.00261   0.00261
</span></span><span class="line"><span class="cl">19  3 16.1 5.79 16.0  0.1553  0.243  0.948  0.230 -0.07446  -0.07446
</span></span><span class="line"><span class="cl">20  3 16.2 5.83 16.0  0.1498  0.243  0.948  0.230 -0.07996  -0.07996
</span></span></code></pre></div><h2 id="side-note-computing-conditional-predicted-values">Side note: computing conditional predicted values</h2>
<p>The conditional predicted value is $\hat{y}_{ij} = XB + Zu$.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">z</span> <span class="o">&lt;-</span> <span class="nf">matrix</span><span class="p">(</span><span class="nf">getME</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="s">&#39;Z&#39;</span><span class="p">),</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span> <span class="c1"># random effect design matrix</span>
</span></span><span class="line"><span class="cl"><span class="n">u</span> <span class="o">&lt;-</span> <span class="nf">ranef</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span><span class="n">[[1]]</span><span class="o">$</span><span class="s">&#39;(Intercept)&#39;</span> <span class="c1"># random effects shrunken</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># getting predicted values (manually)</span>
</span></span><span class="line"><span class="cl"><span class="nf">as.numeric</span><span class="p">(</span><span class="n">X</span> <span class="o">%*%</span> <span class="n">B</span> <span class="o">+</span> <span class="n">z</span> <span class="o">%*%</span> <span class="n">u</span><span class="p">)</span> <span class="c1"># manual</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> [1] 14.5 14.2 14.1 14.5 14.5 14.9 14.3 15.5 15.6 15.8 15.8 16.3 16.2 15.9
</span></span><span class="line"><span class="cl">[15] 16.1 16.4 16.3 16.8 16.2 16.3
</span></span></code></pre></div><p>Can compare this using the function <code>fitted</code> or <code>predict</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">fitted</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="c1"># or predict(m1) (using a function)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">   1    2    4    6    7    8    9   12   13   16   17   21   23   24   25 
</span></span><span class="line"><span class="cl">14.5 14.2 14.1 14.5 14.5 14.9 14.3 15.5 15.6 15.8 15.8 16.3 16.2 15.9 16.1 
</span></span><span class="line"><span class="cl">  26   27   28   29   30 
</span></span><span class="line"><span class="cl">16.4 16.3 16.8 16.2 16.3 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">comb</span><span class="o">$</span><span class="n">y</span> <span class="o">-</span> <span class="n">comb</span><span class="o">$</span><span class="n">residm</span> <span class="c1"># obs - residual</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> [1] 14.5 14.2 14.1 14.5 14.5 14.9 14.3 15.5 15.6 15.8 15.8 16.3 16.2 15.9
</span></span><span class="line"><span class="cl">[15] 16.1 16.4 16.3 16.8 16.2 16.3
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># plotting per group</span>
</span></span><span class="line"><span class="cl"><span class="nf">ggplot</span><span class="p">(</span><span class="n">comb</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">xij</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">fitted</span><span class="p">(</span><span class="n">m1</span><span class="p">)))</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">xij</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">))</span> <span class="o">+</span> <span class="c1">#observed</span>
</span></span><span class="line"><span class="cl">  <span class="c1">#geom_smooth(method = &#39;lm&#39;, se = F, lty = &#39;dashed&#39;, alpha = .5, width = .5) + # overall</span>
</span></span><span class="line"><span class="cl">  <span class="nf">geom_smooth</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">xij</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">fitted</span><span class="p">(</span><span class="n">m1</span><span class="p">),</span> <span class="n">col</span> <span class="o">=</span> <span class="nf">factor</span><span class="p">(</span><span class="n">gp</span><span class="p">)))</span> <span class="o">+</span> <span class="c1"># per cluster</span>
</span></span><span class="line"><span class="cl">  <span class="nf">labs</span><span class="p">(</span><span class="n">col</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&#39;y&#39;</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">geom_abline</span><span class="p">(</span><span class="n">intercept</span> <span class="o">=</span> <span class="nf">fixef</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span><span class="n">[1]</span><span class="p">,</span> <span class="n">slope</span> <span class="o">=</span> <span class="nf">fixef</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span><span class="n">[2]</span><span class="p">)</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">  <span class="nf">theme_bw</span><span class="p">()</span>
</span></span></code></pre></div><p>















<figure  >
  <div class="flex justify-center	">
    <div class="w-100" ><img alt="plot of chunk unnamed-chunk-11" srcset="
               /post/residuals_mlm/unnamed-chunk-11-1_hu_ae9f38f8173320f9.webp 400w,
               /post/residuals_mlm/unnamed-chunk-11-1_hu_2db523d52d9cff62.webp 760w,
               /post/residuals_mlm/unnamed-chunk-11-1_hu_167e45d12bd7e4e8.webp 1200w"
               src="/post/residuals_mlm/unnamed-chunk-11-1_hu_ae9f38f8173320f9.webp"
               width="504"
               height="504"
               loading="lazy" data-zoomable /></div>
  </div></figure>
</p>
<p>A good lecture to view can be found <a href="https://www.bristol.ac.uk/cmm/learning/videos/residuals.html" target="_blank" rel="noopener">here</a>.</p>
<h2 id="computing-studentized-conditional-residuals">Computing studentized (conditional) residuals</h2>
<p>Studentized conditional residuals can be computed as:</p>
$$r_{c, stud} = \frac{r_{cond}}{\sqrt{Var(r_c)}}$$<p>Computing $Var(r_c) = K(V-Q)K'$ where $Q = X(X'V^{-1}X)^{-1}X'$ and $K = I - ZGZ'V^{-1}$ (See Gregoire et al., 1995, p. 144 and the documentation of the <code>redres</code> <a href="https://goodekat.github.io/redres/articles/redres-vignette.html" target="_blank" rel="noopener">package</a>). (It took me a while finding these references!)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">getV</span> <span class="o">&lt;-</span> <span class="kr">function</span><span class="p">(</span><span class="n">x</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">  <span class="n">var.d</span> <span class="o">&lt;-</span> <span class="nf">crossprod</span><span class="p">(</span><span class="nf">getME</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#34;Lambdat&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="n">Zt</span> <span class="o">&lt;-</span> <span class="nf">getME</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s">&#34;Zt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">vr</span> <span class="o">&lt;-</span> <span class="nf">sigma</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="n">^2</span>
</span></span><span class="line"><span class="cl">  <span class="n">var.b</span> <span class="o">&lt;-</span> <span class="n">vr</span> <span class="o">*</span> <span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">Zt</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">var.d</span> <span class="o">%*%</span> <span class="n">Zt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">sI</span> <span class="o">&lt;-</span> <span class="n">vr</span> <span class="o">*</span> <span class="n">Matrix</span><span class="o">::</span><span class="nf">Diagonal</span><span class="p">(</span><span class="nf">nobs</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="c1">#for a sparse matrix</span>
</span></span><span class="line"><span class="cl">  <span class="n">var.y</span> <span class="o">&lt;-</span> <span class="n">var.b</span> <span class="o">+</span> <span class="n">sI</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Vm</span> <span class="o">&lt;-</span> <span class="nf">getV</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Qm</span> <span class="o">&lt;-</span> <span class="n">X</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="n">Vm</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
</span></span></code></pre></div><p>The $G$ matrix here is the random effects matrix and $I$ is an identity matrix.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">Gm</span> <span class="o">&lt;-</span> <span class="nf">diag</span><span class="p">(</span><span class="n">T00</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span> <span class="c1">#this is for a random intercept model with 3 clusters</span>
</span></span><span class="line"><span class="cl"><span class="n">ns</span> <span class="o">&lt;-</span> <span class="nf">nobs</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="c1">#how many observations</span>
</span></span><span class="line"><span class="cl"><span class="n">Im</span> <span class="o">&lt;-</span> <span class="nf">diag</span><span class="p">(</span><span class="n">ns</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Km</span> <span class="o">&lt;-</span> <span class="n">Im</span> <span class="o">-</span> <span class="n">z</span> <span class="o">%*%</span> <span class="n">Gm</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">solve</span><span class="p">(</span><span class="n">Vm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">var_rcm</span> <span class="o">&lt;-</span> <span class="nf">diag</span><span class="p">(</span><span class="n">Km</span> <span class="o">%*%</span> <span class="p">(</span><span class="n">Vm</span> <span class="o">-</span> <span class="n">Qm</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">t</span><span class="p">(</span><span class="n">Km</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="nf">resid</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="o">/</span> <span class="nf">sqrt</span><span class="p">(</span><span class="n">var_rcm</span><span class="p">)</span> <span class="c1"># computing the studentized residuals</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">       1        2        4        6        7        8        9       12 
</span></span><span class="line"><span class="cl">-1.68395  1.22106  0.26862  0.05464 -0.24871 -0.05374 -0.29279  0.00643 
</span></span><span class="line"><span class="cl">      13       16       17       21       23       24       25       26 
</span></span><span class="line"><span class="cl"> 1.28655  0.17231 -1.03160 -2.03424  2.30656 -0.90587  0.87623  0.79787 
</span></span><span class="line"><span class="cl">      27       28       29       30 
</span></span><span class="line"><span class="cl">-0.20766  0.00981 -0.24161 -0.25913 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">rstudent</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span> <span class="c1">#automatic, using a function</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">       1        2        4        6        7        8        9       12 
</span></span><span class="line"><span class="cl">-1.68395  1.22106  0.26862  0.05464 -0.24871 -0.05374 -0.29279  0.00643 
</span></span><span class="line"><span class="cl">      13       16       17       21       23       24       25       26 
</span></span><span class="line"><span class="cl"> 1.28655  0.17231 -1.03160 -2.03424  2.30656 -0.90587  0.87623  0.79787 
</span></span><span class="line"><span class="cl">      27       28       29       30 
</span></span><span class="line"><span class="cl">-0.20766  0.00981 -0.24161 -0.25913 
</span></span></code></pre></div><p><strong>References</strong>:</p>
<p>Gregoire, T. G., Schabenberger, O., &amp; Barrett, J. P. (1995). Linear modelling of irregularly spaced, unbalanced, longitudinal data from permanent-plot measurements. <em>Canadian Journal of Forest Research, 25</em>(1), 137-156.</p>
<p>&mdash; END</p>

  </article>
</div>




<div class="flex flex-col items-center">

  <div class="container max-w-[65ch] mx-auto bg-white dark:bg-zinc-900 rounded-xl border-gray-100 dark:border-gray-700 border shadow-md overflow-hidden my-5">


  
  

  </div>


  


</div>


    </div>
    <div class="page-footer">
      <footer class="container mx-auto flex flex-col justify-items-center text-sm leading-6 mt-24 mb-4 text-slate-700 dark:text-slate-200">

  












  
  
  
  
  














  
  
  

  
  
    
  
  
    
  

  

  
  <p class="powered-by text-center">
    © 2025 Grumblesquasher. This work is licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0" rel="noopener noreferrer" target="_blank">CC BY NC SA 4.0</a>
  </p>
  

  <p class="powered-by footer-license-icons">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0" rel="noopener noreferrer" target="_blank" aria-label="Creative Commons">
      <i class="fab fa-creative-commons fa-2x" aria-hidden="true"></i>
      <i class="fab fa-creative-commons-by fa-2x" aria-hidden="true"></i>
      
        <i class="fab fa-creative-commons-nc fa-2x" aria-hidden="true"></i>
      
      
        <i class="fab fa-creative-commons-sa fa-2x" aria-hidden="true"></i>
      
    </a>
  </p>





  <p class="powered-by text-center">
    
    
    
      
      
      
      
      
      
      Published with <a href="https://hugoblox.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Hugo Blox Builder</a> — the free, <a href="https://github.com/HugoBlox/hugo-blox-builder" target="_blank" rel="noopener">open source</a> website builder that empowers creators.
    
  </p>

</footer>

    </div>

    
    











  </body>
</html>
